# CLAUDE.md

DEM Backend - FastAPI elevation service for Road Engineering SaaS platform.

## ðŸš€ INTEGRATION COMPLETE - PRODUCTION READY

**Status**: Index-driven source integration successfully implemented and validated  
**Performance**: 54,000x speedup for Brisbane coordinates via S3 campaign selection  
**Coverage**: 1,151 S3 campaigns + API fallback chain (GPXZ â†’ Google)  
**Architecture**: Unified spatial indexing with O(log N) geographic lookups

## ðŸš¨ CRITICAL RULES
- **NEVER start uvicorn** without user permission - check `netstat -ano | findstr :8001` first
- **NEVER modify .env files** - contains sensitive credentials

## Quick Start

### Environment Switching
- **Local**: `python scripts/switch_environment.py local` â†’ `uvicorn src.main:app --host 0.0.0.0 --port 8001 --reload`
- **API Test**: `python scripts/switch_environment.py api-test` â†’ start service  
- **Production**: `python scripts/switch_environment.py production` â†’ start service

### Virtual Environment
- **Activate**: `.\venv\Scripts\activate.bat`
- **Install**: `pip install -r requirements.txt`

## Production Deployment

**Railway Status**: `https://dem-elevation-backend-production.up.railway.app` âœ…  
**Service ID**: `cda12ccf-822d-4bb9-b804-44099401b462`  
**Plan**: Hobby ($5/month, 8GB RAM)

**Deploy**: `railway up --detach --service cda12ccf-822d-4bb9-b804-44099401b462`  
**Variables**: `railway variables --set "KEY=value" --service cda12ccf-822d-4bb9-b804-44099401b462`

## Testing

- **All tests**: `pytest tests/`
- **Integration validation**: `python test_integration.py`
- **API health**: `curl http://localhost:8001/api/v1/health`
- **Point elevation**:
```bash
curl -X POST "http://localhost:8001/api/v1/elevation/point" \
  -H "Content-Type: application/json" \
  -d '{"latitude": -27.4698, "longitude": 153.0251}'
```

## âš¡ Index-Driven Source Integration

**Implementation Status**: âœ… Complete and Production-Ready

### Key Features
- **1,151 S3 Campaigns**: Loaded from `phase3_campaign_populated_index.json`
- **Spatial Indexing**: 50x50 grid with 849/2500 occupied cells, avg 4.5 campaigns/cell
- **Geographic Selection**: Brisbane â†’ Brisbane2009LGA (1m resolution S3 campaign)
- **Fallback Chain**: Ocean coordinates â†’ GPXZ API â†’ Google API
- **Performance**: 54,000x speedup for covered areas vs API calls

### Architecture Components
- **IndexDrivenSourceSelector**: Spatial indexing with overlap resolution
- **UnifiedElevationService**: Auto-detects S3 campaigns, uses appropriate selector
- **Enhanced Sources Endpoint**: `/api/v1/elevation/sources` shows performance stats
- **Graceful Degradation**: API fallback for uncovered geographic areas

### Validation Results
```
âœ… Configuration Loading: 1,151 S3 campaigns + 2 API sources
âœ… Spatial Indexing: Brisbane â†’ Brisbane2009LGA (S3, 1m)  
âœ… Performance Statistics: Optimal spatial distribution
âœ… Service Integration: IndexDrivenSourceSelector active
âœ… Fallback Validation: Ocean â†’ gpxz_api (API fallback)
âœ… Edge Case Testing: Deterministic overlap resolution
```


## Configuration

**Environment Files**: `.env.local`, `.env.api-test`, `.env.production`  
**Active Config**: `.env` (auto-generated by switch scripts)  
**Config Class**: `src/config.py`

**Key Variables**:
- `DEM_SOURCES` - JSON source definitions
- `USE_S3_SOURCES` - Enable S3 data sources  
- `USE_API_SOURCES` - Enable external APIs
- `AWS_ACCESS_KEY_ID/SECRET` - S3 credentials
- `GPXZ_API_KEY` - GPXZ.io API access


## Architecture

**Role**: Elevation data microservice for Road Engineering SaaS platform  
**Main Platform**: `C:\Users\Admin\road-engineering-branch\road-engineering`  
**Data Sources**: S3 (3.6TB) â†’ GPXZ API â†’ Google API (fallback chain)  
**Ports**: DEM Backend (8001), Main Backend (3001)  
**CORS**: `localhost:5173/5174/3001`

## Data Sources (Priority Order)

1. **S3 DEM Files**: `road-engineering-elevation-data` (214k+ files), `nz-elevation` (1.7k files)
2. **GPXZ.io API**: Global coverage, 100 req/day free
3. **Google Elevation**: Fallback, 2.5k req/day free  
4. **Local**: .gdb/.tif files (development only)

## Key Components

- **Main App**: `src/main.py` - FastAPI with CORS
- **DEM Service**: `src/dem_service.py` - Core elevation logic
- **Endpoints**: `src/api/v1/endpoints.py` - `/point`, `/points`, `/path`, `/contour-data`
- **Config**: `src/config.py` - Environment management
- **Source Selector**: `src/enhanced_source_selector.py` - Fallback chain
- **Campaign Selector**: `src/campaign_dataset_selector.py` - Smart S3 selection
- **S3 Loader**: `src/s3_index_loader.py` - Spatial indexing

## Performance

**Brisbane CBD**: 54,000x speedup (Campaign-based selection)  
**Sydney Harbor**: 672x speedup  
**Response Time**: <100ms metro, <200ms regional  
**Memory**: ~600MB S3 indexes


## Key Features

- **Multi-source fallback**: S3 â†’ GPXZ API â†’ Google API
- **Resource-safe caching**: LRU cache with auto cleanup
- **Async operations**: True async without thread pools
- **Circuit breaker**: Prevents cascading failures
- **Spatial indexing**: Campaign-based smart selection


## Troubleshooting

**Service won't start**: 
- Check `.env` exists with DEM_SOURCES
- Reset: `python scripts/switch_environment.py local`

**Elevation returns null**:
- Check logs for source failures
- Verify API keys (GPXZ_API_KEY, AWS credentials)
- Test fallback: Switch to local mode

**Rate limits exceeded**:
- GPXZ: 100 req/day, resets midnight
- S3: Check `.s3_usage.json`

**Performance issues**:
- Use batch endpoints for multiple points
- Check network connectivity
- Wait for circuit breaker recovery (60-300s)

**Diagnostic Commands**:
```bash
# Test config
python -c "from src.config import Settings; print(Settings())"

# Test production
curl "https://dem-elevation-backend-production.up.railway.app/api/v1/health"
```

## Data Management

**Update S3 Campaign Index** (after adding new DEM files):
```bash
python scripts/manual_campaign_update.py --analyze
python scripts/manual_campaign_update.py --update
python scripts/manual_campaign_update.py --validate
```

**Spatial Index Generation**:
- Australian: `python scripts/generate_spatial_index.py generate`
- New Zealand: `python scripts/generate_nz_spatial_index.py generate`